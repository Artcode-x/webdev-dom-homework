<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Проект "Комменты"</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments" id="box">
      <!-- код отсюда теперь в массиве js-->
    </ul>
    <div class="add-form">
      <input type="text" id="name-input" value="Alex D" class="add-form-name" placeholder="Введите ваше имя" />
      <textarea type="textarea" id="text-input" value="test-text" class="add-form-text"
        placeholder="Введите ваш коментарий" rows="4"></textarea>
      <div class="add-form-row">
        <button id="add-button" class="add-form-button">Написать</button>
      </div>
    </div>
  </div>
</body>

<script>
  const buttonElement = document.getElementById('add-button'); // +
  //const listElement = document.getElementById('list');
  const nameInputElement = document.getElementById('name-input'); // +
  const textInputElement = document.getElementById('text-input'); // +
  const newBox = document.getElementById('box'); // +
  const quoteNameElement = document.getElementById("quote__name")
  const icomments = [ // данные о комментариях хранятся тут
    {
      name: "Глеб Фокин",
      date: "12.02.22 12:18",
      like: 3,
      comment: "Это будет первый комментарий на этой странице",
      //  paint: "",
      txtRedact: true,
      userLike: false,
      quoteName: "",
      quoteComment: "",
    },
    {
      name: "Варвара Н",
      date: "13.02.22 19:22",
      like: 75,
      comment: "Мне нравится как оформлена эта страница!",
      //  paint: "-active-like",
      txtRedact: true,
      userLike: true,
      quoteName: "",
      quoteComment: "",
    },
  ];

  const renderIcomments = () => { // тут будем рендерить комменты
    const icommentsHTML = icomments.map((icomment, index) => {
      return ` <li class="comment">
        <div class="comment-header">
          <div id="quote__name">${icomment.name}</div>
          <div>${icomment.date}</div>
        </div>
        <div class="comment-body">
          <div data-comments="${index}" class="comment-text">
           ${icomment.comment}
          </div>
        </div>
        <div class="comment-footer">
          <button data-redact="${index}" class="redact">Редактировать</button>
          <div class="likes">
            <span class="likes-counter">${icomment.like}</span>
            <button data-index="${index}" class="${icomment.userLike ? 'like-button -active-like' : 'like-button'}"></button>
          </div>
        </div>
      </li>`;

    }).join('');  // а после этого проверяем через консоль и кладем в innerHTML полученную строку
    // console.log(icommentsHTML); // Тут видно данные с массива
    newBox.innerHTML = icommentsHTML; // Рендерим данные с массива
    // };

    buttonEditText();

    // Тут были сложности
    const answerComments = document.querySelectorAll(".comment-text");

    for (const answerComment of answerComments) {
      answerComment.addEventListener("click", (event) => {
        //console.log({event});
        event.stopPropagation();
        const zindex = answerComment.dataset.comments;


        //  возникла путанница
        if (!icomments[zindex].txtRedact) return;
        const answerName = icomments[zindex].name;
        const ansComment = icomments[zindex].comment;

        textInputElement.value = `>` + " " + answerName + ansComment;

        renderIcomments();
      });
    }

    // quoteNameElement.innerHTML = icomments[index].name;
    // quoteBodyElement.innerHTML = icomments[index].comment;
    // //  itext = icomments.splice(icomments, 1); 

    //   });
    // }


    const likeButtonElements = document.querySelectorAll(".like-button");

    for (const likeButtonElement of likeButtonElements) {
      // for (Элемент of итерируемый обьект) { тело цикла for of }       
      likeButtonElement.addEventListener("click", () => {
        const index = likeButtonElement.dataset.index;
        // с помощью св-ва dataset можно получить доступ к data-атрибутам с пом-ю js (у эл-та dom дерева)
        if (icomments[index].userLike === false) {
          icomments[index].paint = "-active-like";
          icomments[index].like += 1;
          icomments[index].userLike = true;
        } else {
          icomments[index].paint = '';
          icomments[index].like -= 1;
          icomments[index].userLike = false;
        }
        renderIcomments()
      });
    }
  };

  renderIcomments();


  function buttonEditText(buttonRedacts) { // обернул в ф-ию чтобы было удобно вызывать где нужно

    buttonRedacts = document.querySelectorAll(".redact");
    // for ( берем Элемент из итерируемого объекта) {тело цикла}
    for (const buttonRedact of buttonRedacts) {
      buttonRedact.addEventListener("click", () => {
        // с пом-ю св-ва dataset получаем доступ к data-атрибуту redact (который указали в рендер-html форме, в кнопке редактирования) 
        const index = buttonRedact.dataset.redact;

        if (buttonRedacts[index].innerHTML === "Редактировать") {
          buttonRedacts[index].innerHTML = "Сохранить";
          icomments[index].txtRedact = false;
          const commentBodyElements = document.querySelectorAll(".comment-text");
          const commentBodyElement = commentBodyElements[index];
          const textareaElement = `<textarea type="textarea" class="redactor-txt" rows="4">${icomments[index].comment}</textarea>`;
          commentBodyElement.innerHTML = textareaElement;
        } else {
          icomments[index].txtRedact = true;
          const redactCommentElement = document.querySelectorAll(".redactor-txt");
          icomments[index].comment = protectHtmlString(redactCommentElement[0].value);
          renderIcomments();
        }
      });
    }
    return buttonEditText;
  }

  function protectHtmlString(someEdit) {
    someEdit = someEdit
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
    return someEdit;
  }



  const giveMeTime = 'ru-RU';
  let todayData = { day: 'numeric', month: 'numeric', year: '2-digit' };
  let todayTime = { hour: 'numeric', minute: '2-digit' };
  let date = new Date();


  buttonElement.addEventListener('click', () => {  // Добавляем обработчик события "клик" на элемент buttonElement.
    //console.log(textInputElement.value);

    nameInputElement.classList.remove("error"); // Убирает у элемента класс error
    textInputElement.classList.remove("error")
    if (nameInputElement.value === "" || textInputElement.value === "") { // если значения полей имени или текста будут пустыми, применится класс error.(красный цвет полей)
      nameInputElement.classList.add("error"); textInputElement.classList.add("error");
      return;
    }
    const oldListHtml = newBox.innerHTML; // читаем из newBox все содержимое // Для того чтобы посмотреть или изменить содержимое эл-та исп-ся св-во innerHTML (например console.log(element.innerHTML))

    //   newBox.innerHTML = oldListHtml + // тут мы обновляем содержимое эл-та  // Далее приклеиваем к содержимому эл-та в данном случае html код.

    icomments.push({
      // это старый код name: `${nameInputElement.value       // но лучше:  name: protectHtmlString(nameInputElement.value),
      //   .replaceAll("<", "&lt")
      //   .replaceAll(">", "&gt")
      //   .replaceAll('"', "&quot")
      //   }`,

      // это старый код comment: `${textInputElement.value    //   comment: protectHtmlString(textInputElement.value),
      //   .replaceAll("<", "&lt")
      //   .replaceAll(">", "&gt")
      //   .replaceAll('"', "&quot")
      //   }`,
      name: protectHtmlString(nameInputElement.value),
      comment: protectHtmlString(textInputElement.value),
      date: `${date.toLocaleString(giveMeTime, todayData)} ${date.toLocaleString(giveMeTime, todayTime)}`,
      like: 0,
      paint: '',
      txtRedact: true,
      userLike: false,
      // quoteName: quoteNameElement.innerHTML,
      // quoteComment: quoteBodyElement.innerHTML
    });

    // можно и лучше сделать так:   Используем ф-ию которую создали ранее, чтобы не плодить много кода
    // icomments.push({
    //   name: protectHtmlString(nameInputElement.value),
    //   comment: protectHtmlString(textInputElement.value),
    //   date: `${date.toLocaleString(giveMeTime, todayTime)} ${date.toLocaleString(giveMeTime, todayTime)}`,
    //   like: 0,
    //   paint: '',
    //   txtRedact: true,
    //   userLike: false,
    // });

    renderIcomments();

  });


</script>

</html>